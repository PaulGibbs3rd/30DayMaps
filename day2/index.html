<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location History Map</title>
    <script type="module" src="https://js.arcgis.com/calcite-components/2.11.1/calcite.esm.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/2.11.1/calcite.css"/>
    <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.30/"></script>
    <style>
        html, body, #viewDiv, #timeSliderDiv {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        #timeSliderDiv {
            position: absolute;
            bottom: 10px;
            left: 20px;
            width: 90%;
            background-color: white;
            padding: 10px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
            z-index: 99;
        }

        #titleDiv {
            padding: 10px;
            font-weight: 36;
            text-align: center;
        }

        #timeSlider {
            position: absolute;
            left: 5%;
            right: 5%;
            bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="viewDiv"></div>
    <div id="timeSlider"></div>
    <div id="titleDiv" class="esri-widget">
        <div id="titleText">Location History Overview</div>
    </div>
    <calcite-input-time-zone mode="name" id="timezone-picker"></calcite-input-time-zone>
    <script>
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/GeoJSONLayer",
            "esri/widgets/TimeSlider",
            "esri/widgets/Expand",
            "esri/widgets/Legend",
            "esri/widgets/TimeZoneLabel"
        ], function(Map, MapView, GeoJSONLayer, TimeSlider, Expand, Legend, TimeZoneLabel) {

            // URL to point GeoJSON file hosted in the repository
            const pointLayerUrl = "https://raw.githubusercontent.com/PaulGibbs3rd/30DayMaps/main/day2/LocationHistor_FeaturesToJSO.geojson";

            // URL to polyline GeoJSON file hosted in the repository
            const polylineLayerUrl = "https://raw.githubusercontent.com/PaulGibbs3rd/30DayMaps/main/day2/LocationHistoryPolyline_FeaturesToJSO.geojson";

            // GeoJSON layer for Points with unique value renderer
            const pointLayer = new GeoJSONLayer({
                url: pointLayerUrl,
                renderer: {
                    type: "unique-value",
                    field: "type",  // Unique value field for points
                    uniqueValueInfos: [
                        {
                            value: "Start",
                            symbol: {
                                type: "simple-marker",
                                style: "circle",
                                color: "green",
                                size: 6,
                                outline: {
                                    width: 1,
                                    color: "white"
                                }
                            },
                            label: "Start Point"
                        },
                        {
                            value: "End",
                            symbol: {
                                type: "simple-marker",
                                style: "circle",
                                color: "red",
                                size: 6,
                                outline: {
                                    width: 1,
                                    color: "white"
                                }
                            },
                            label: "End Point"
                        }
                    ]
                },
                timeInfo: {
                    startField: "startDate",  // Replace with the correct start date field in your GeoJSON
                    endField: "endDate"       // Replace with the correct end date field in your GeoJSON
                },
                popupTemplate: {
                    title: "Location Point",
                    content: "<b>Type:</b> {type}<br><b>Start Date:</b> {startDate}<br><b>End Date:</b> {endDate}"
                }
            });

            // GeoJSON layer for Polylines with unique value renderer
            const polylineLayer = new GeoJSONLayer({
                url: polylineLayerUrl,
                renderer: {
                    type: "unique-value",
                    field: "type_change",  // Unique value field for polylines
                    uniqueValueInfos: [
                        {
                            value: "Move",
                            symbol: {
                                type: "simple-line",
                                color: "blue",
                                width: 2
                            },
                            label: "Movement Path"
                        },
                        {
                            value: "Stop",
                            symbol: {
                                type: "simple-line",
                                color: "orange",
                                width: 2
                            },
                            label: "Stop Path"
                        }
                    ]
                },
                timeInfo: {
                    startField: "startDate",  // Replace with the correct start date field in your GeoJSON
                    endField: "endDate"       // Replace with the correct end date field in your GeoJSON
                },
                popupTemplate: {
                    title: "Movement Path",
                    content: "<b>Type Change:</b> {type_change}<br><b>Start Date:</b> {startDate}<br><b>End Date:</b> {endDate}"
                }
            });

            // Create the map
            const map = new Map({
                basemap: "streets-navigation-vector",
                layers: [pointLayer, polylineLayer]
            });

            // Create the view
            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-100.33, 25.69], // Adjust center coordinates as per your data's location
                zoom: 5
            });

            // Add the TimeSlider widget
            const timeSlider = new TimeSlider({
                container: "timeSlider",
                view: view,
                timeVisible: true, // show the time stamps on the timeslider
                loop: true
            });

            // Wait until the view is ready to set the time extent
            view.whenLayerView(pointLayer).then(function() {
                pointLayer.when(() => {
                    const fullTimeExtent = {
                        start: new Date(2022, 0, 1),
                        end: new Date(2023, 0, 1)
                    };
                    timeSlider.fullTimeExtent = fullTimeExtent;
                    timeSlider.stops = {
                        interval: {
                            value: 1,
                            unit: "days"
                        }
                    };
                    timeSlider.values = [new Date(2022, 0, 1), new Date(2022, 6, 1)];
                });
            }).catch((error) => {
                console.error("Failed to load point layer view:", error);
            });

            // Load GeoJSON layers and add error handling
            pointLayer.load().then(() => {
                console.log("Point Layer Loaded");
            }).catch((error) => {
                console.error("Failed to load point layer:", error);
            });

            polylineLayer.load().then(() => {
                console.log("Polyline Layer Loaded");
            }).catch((error) => {
                console.error("Failed to load polyline layer:", error);
            });

            // TimeZoneLabel lets users know what the time zone of the view is.
            view.ui.add(new TimeZoneLabel({ view: view }), "top-left");

            // Calcite input time zone component allows users to pick from one of the IANA time zones
            const timezonePicker = document.getElementById("timezone-picker");
            view.ui.add("timezone-picker", "top-right");

            // Change the map view's time zone when user picks a time zone from the component
            timezonePicker.addEventListener("calciteInputTimeZoneChange", () => {
                view.timeZone = timezonePicker.value;
            });

            // Add a legend to the view
            const legend = new Legend({
                view: view
            });
            const legendExpand = new Expand({
                expandIcon: "legend",
                expandTooltip: "Legend",
                view: view,
                content: legend,
                expanded: false
            });
            view.ui.add(legendExpand, "top-left");
        });
    </script>
</body>
</html>
