<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Day 3 Map with Polygons</title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.30/esri/themes/light/main.css"
    />
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/calcite-components/1.0.0-beta.79/calcite.css"
    />
    <script type="module" src="https://js.arcgis.com/calcite-components/1.0.0-beta.79/calcite.esm.js"></script>
    <script nomodule="" src="https://js.arcgis.com/calcite-components/1.0.0-beta.79/calcite.js"></script>
    <script src="https://js.arcgis.com/4.30/"></script>
    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      #resultsTable {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border: 1px solid black;
        z-index: 100;
        max-height: 400px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <div id="viewDiv"></div>
    <calcite-panel id="resultsPanel" style="position: absolute; top: 10px; left: 10px; z-index: 100;">
      <h3 slot="header-content">Top 10 Cities by Point Count</h3>
      <calcite-table>
        <thead>
          <tr>
            <th>City</th>
            <th>County</th>
            <th>State</th>
            <th>Point Count</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </calcite-table>
    </calcite-panel>
    <script>
      require(["esri/Map", "esri/views/MapView", "esri/layers/FeatureLayer", "esri/layers/GeoJSONLayer", "esri/widgets/LayerList", "esri/rest/query"], function (Map, MapView, FeatureLayer, GeoJSONLayer, LayerList, query) {
        // Create the map
        var map = new Map({
          basemap: "streets-navigation-vector"
        });

        // Create the MapView
        var view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-98.5795, 39.8283], // Center of the United States
          zoom: 4
        });

        // Define URLs for GeoJSON layers
        var pointGeoJsonUrl = "https://raw.githubusercontent.com/PaulGibbs3rd/30DayMaps/main/day2/LocationHistor_FeaturesToJSO.geojson";
        
        // URL for the California cities feature layer
        var californiaCitiesFeatureLayerUrl = "https://services7.arcgis.com/RZTs81UMZhbC5iCo/arcgis/rest/services/California_Cities_(Polygons)/FeatureServer/0";
        
        // URL for the Oregon cities feature layer
        var oregonCitiesFeatureLayerUrl = "https://gis.odot.state.or.us/arcgis1006/rest/services/data_layers/city_limits/MapServer/0";
        
        // URL for the Washington cities feature layer (specify layer index 0 explicitly)
        var washingtonCitiesFeatureLayerUrl = "https://services2.arcgis.com/J4VMdGWiZXReffvo/arcgis/rest/services/CityLimits/FeatureServer/0";

        // Create the California cities feature layer
        var californiaCitiesLayer = new FeatureLayer({
          url: californiaCitiesFeatureLayerUrl,
          title: "California Cities",
        });

        // Create the Oregon cities feature layer
        var oregonCitiesLayer = new FeatureLayer({
          url: oregonCitiesFeatureLayerUrl,
          title: "Oregon Cities",
        });

        // Create the Washington cities feature layer
        var washingtonCitiesLayer = new FeatureLayer({
          url: washingtonCitiesFeatureLayerUrl,
          title: "Washington Cities",
        });

        // Create GeoJSONLayer for points
        var pointLayer = new GeoJSONLayer({
          url: pointGeoJsonUrl,
          title: "Point Location History",
        });

        // Add the layers to the map
        map.addMany([californiaCitiesLayer, oregonCitiesLayer, washingtonCitiesLayer, pointLayer]);

        // Create a LayerList widget instance and add it to the view
        var layerList = new LayerList({
          view: view
        });

        view.ui.add(layerList, "top-right");

        // Function to perform spatial queries to find points within each city
        function performSpatialQueries() {
          var cityLayers = [californiaCitiesLayer, oregonCitiesLayer, washingtonCitiesLayer];
          var cityPointCounts = [];

          var promises = cityLayers.map(function (cityLayer) {
            var queryOptions = {
              where: "1=1",
              returnGeometry: true,
              outFields: ["*"],
            };
            return query.executeQueryJSON(cityLayer.url, queryOptions).then(function (cityFeatureSet) {
              var cityPromises = cityFeatureSet.features.map(function (cityFeature) {
                var cityGeometry = cityFeature.geometry;
                var pointQueryOptions = {
                  geometry: cityGeometry,
                  spatialRelationship: "intersects",
                  returnGeometry: false,
                  outFields: ["*"],
                };
                return query.executeQueryJSON(pointLayer.url, pointQueryOptions).then(function (pointFeatureSet) {
                  var pointCount = pointFeatureSet.features.length;
                  var cityName = cityFeature.attributes["CITY_NAME"] || "Unknown City";
                  var countyName = cityFeature.attributes["COUNTY_NAME"] || "Unknown County";
                  var stateName = cityFeature.attributes["STATE_NAME"] || "Unknown State";

                  cityPointCounts.push({
                    city: cityName,
                    county: countyName,
                    state: stateName,
                    count: pointCount,
                  });
                });
              });
              return Promise.all(cityPromises);
            });
          });

          Promise.all(promises).then(function () {
            // Sort cityPointCounts by count in descending order and take the top 10
            cityPointCounts.sort(function (a, b) {
              return b.count - a.count;
            });
            var top10Cities = cityPointCounts.slice(0, 10);

            // Populate the table with the top 10 cities
            var tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = ""; // Clear any previous results
            top10Cities.forEach(function (cityData) {
              var row = document.createElement("tr");
              row.innerHTML = "<td>" + cityData.city + "</td><td>" + cityData.county + "</td><td>" + cityData.state + "</td><td>" + cityData.count + "</td>";
              tableBody.appendChild(row);
            });
          });
        }

        // Wait until the point layer is loaded, then perform spatial queries
        pointLayer.when(function () {
          performSpatialQueries();
        });
      });
    </script>
  </body>
</html>
